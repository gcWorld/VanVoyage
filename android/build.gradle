buildscript {
    ext.kotlin_version = '1.9.10'
    repositories {
        google()
        mavenCentral()
    }

    dependencies {
        classpath 'com.android.tools.build:gradle:8.1.0'
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
        
        // Mapbox Maven repository
        maven {
            url 'https://api.mapbox.com/downloads/v2/releases/maven'
            authentication {
                basic(BasicAuthentication)
            }
            credentials {
                username = 'mapbox'
                // Use token from environment variable or gradle.properties
                password = System.getenv("MAPBOX_DOWNLOADS_TOKEN") ?: project.findProperty("MAPBOX_DOWNLOADS_TOKEN") ?: ""
            }
        }
    }
}

rootProject.buildDir = '../build'
subprojects {
    project.buildDir = "${rootProject.buildDir}/${project.name}"
}

subprojects {
    // Define Flutter extension properties for plugins before they evaluate
    beforeEvaluate {
        // Read MAPBOX_DOWNLOADS_TOKEN from local.properties, environment, or gradle.properties
        def localPropsFile = rootProject.file('local.properties')
        def mapboxToken = null
        
        if (localPropsFile.exists()) {
            def Properties localProps = new Properties()
            localPropsFile.withReader('UTF-8') { reader -> localProps.load(reader) }
            mapboxToken = localProps.getProperty('MAPBOX_DOWNLOADS_TOKEN')
        }
        
        // Fallback to environment variable or gradle.properties
        if (!mapboxToken) {
            mapboxToken = System.getenv("MAPBOX_DOWNLOADS_TOKEN") ?: findProperty("MAPBOX_DOWNLOADS_TOKEN")
        }
        
        // Make token available as project property for plugin validation
        if (mapboxToken && !project.hasProperty("MAPBOX_DOWNLOADS_TOKEN")) {
            project.ext.set("MAPBOX_DOWNLOADS_TOKEN", mapboxToken)
        }
        
        def flutterExt = [:]
        flutterExt.compileSdkVersion = findProperty('flutter.compileSdkVersion')?.toInteger() ?: 34
        flutterExt.targetSdkVersion = findProperty('flutter.targetSdkVersion')?.toInteger() ?: 34
        flutterExt.minSdkVersion = findProperty('flutter.minSdkVersion')?.toInteger() ?: 21
        flutterExt.ndkVersion = findProperty('flutter.ndkVersion') ?: '25.1.8937393'
        flutterExt.buildToolsVersion = findProperty('flutter.buildToolsVersion') ?: '34.0.0'

        // Try to read flutter.sdk from local.properties if present so Gradle plugin can locate the SDK
        if (localPropsFile.exists()) {
            def Properties localProps = new Properties()
            localPropsFile.withReader('UTF-8') { reader -> localProps.load(reader) }
            if (localProps.getProperty('flutter.sdk')) {
                flutterExt.sdk = localProps.getProperty('flutter.sdk')
            }
        }

        // Provide the Flutter source directory relative to the android folder (project root)
        // This is used by the new Flutter Gradle plugin which expects a `flutter.source` property.
        flutterExt.source = rootProject.projectDir.parentFile?.absolutePath ?: project.rootDir.parentFile?.absolutePath

        ext.flutter = flutterExt
    }
}

tasks.register("clean", Delete) {
    delete rootProject.buildDir
}
