name: Flutter CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    env:
      MAPBOX_DOWNLOADS_TOKEN: ${{ secrets.MAPBOX_DOWNLOADS_TOKEN }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.x'
        channel: 'stable'

    - name: Create secrets.dart from repository secret
      run: |
        cat > lib/secrets.dart << EOF
        // Auto-generated from repository secret
        // Do not edit this file manually in CI/CD environment
        
        /// Mapbox API key for map services
        const String mapboxApiKey = '${{ secrets.MAPBOX_TOKEN }}';
        EOF
      shell: bash

    - name: Configure Android build
      run: |
        # Ensure android/local.properties contains flutter.sdk so the Gradle plugin can locate the Flutter SDK
        mkdir -p android
        echo "flutter.sdk=$FLUTTER_ROOT" > android/local.properties
        echo "sdk.dir=$ANDROID_SDK_ROOT" >> android/local.properties || true
        # Add Mapbox downloads token to gradle.properties as backup
        if [ -n "$MAPBOX_DOWNLOADS_TOKEN" ]; then
          echo "MAPBOX_DOWNLOADS_TOKEN=$MAPBOX_DOWNLOADS_TOKEN" >> android/gradle.properties
        fi

    - name: Install dependencies
      run: flutter pub get

    - name: Generate code (mocks, etc.)
      run: dart run build_runner build --delete-conflicting-outputs

    - name: Format and check code
      run: |
        dart format .
        if ! git diff --quiet; then
          echo "⚠️ Code formatting changes detected. Please run 'dart format .' locally and commit the changes."
          git diff --name-only
        fi

    - name: Analyze code
      run: flutter analyze

    - name: Run tests
      run: flutter test

    - name: Build APK (Android)
      run: flutter build apk --debug

  lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.x'
        channel: 'stable'

    - name: Create secrets.dart from repository secret
      run: |
        cat > lib/secrets.dart << EOF
        // Auto-generated from repository secret
        // Do not edit this file manually in CI/CD environment
        
        /// Mapbox API key for map services
        const String mapboxApiKey = '${{ secrets.MAPBOX_TOKEN }}';
        EOF
      shell: bash

    - name: Install dependencies
      run: flutter pub get

    - name: Generate code (mocks, etc.)
      run: dart run build_runner build --delete-conflicting-outputs

    - name: Format and check code
      run: |
        dart format .
        if ! git diff --quiet; then
          echo "⚠️ Code formatting changes detected. Please run 'dart format .' locally and commit the changes."
          git diff --name-only
        fi

    - name: Analyze project source
      run: flutter analyze --no-fatal-infos
